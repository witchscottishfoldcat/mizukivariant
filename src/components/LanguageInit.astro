---
// 这个组件用于在页面加载时尽早初始化语言设置
import { siteConfig } from "../config";

// 尝试从Cookie中获取语言设置
function getLanguageFromCookie(request: Request) {
  const cookieHeader = request.headers.get("cookie") || "";
  console.log("LanguageInit (服务端): Cookie头", cookieHeader);
  const cookies = cookieHeader.split(";").map(c => c.trim());
  const languageCookie = cookies.find(c => c.startsWith("language="));
  const cookieLang = languageCookie ? languageCookie.split("=")[1]?.trim() : null;
  console.log("LanguageInit (服务端): 提取的语言", cookieLang);
  return cookieLang || siteConfig.lang;
}

// 获取当前请求的语言
let currentLang: string = siteConfig.lang;
// @ts-ignore - Astro is available globally in Astro components
if (Astro.request) {
  // @ts-ignore
  const cookieLang = getLanguageFromCookie(Astro.request);
  if (cookieLang && cookieLang !== siteConfig.lang) {
    // @ts-ignore - cookieLang 可能是任何字符串，但我们需要接受它
    currentLang = cookieLang as any;
    console.log("LanguageInit (服务端): 从Cookie读取语言", currentLang);
  } else {
    console.log("LanguageInit (服务端): 使用默认语言", currentLang, "Cookie语言", cookieLang);
  }
} else {
  console.log("LanguageInit (服务端): Astro.request 不可用，使用默认语言", currentLang);
}
---

<script is:inline define:vars={{currentLang}}>
  // 在页面渲染前尽早初始化语言设置
  (function() {
    // 获取语言设置
    let lang = currentLang;
    console.log("LanguageInit: 服务端语言", lang);
    
    // 如果没有在服务端获取到语言，尝试从localStorage获取
    if (typeof window !== "undefined") {
      // 优先从 Cookie 读取（与服务端保持一致）
      const cookieLang = document.cookie
        .split(";")
        .find(c => c.trim().startsWith("language="))
        ?.split("=")[1]
        ?.trim();
      console.log("LanguageInit: Cookie中的语言", cookieLang);
      
      if (cookieLang) {
        lang = cookieLang;
        // 同步到 localStorage
        localStorage.setItem("language", lang);
        console.log("LanguageInit: 从Cookie设置语言", lang);
      } else {
        // 如果没有 Cookie，从 localStorage 获取
        const storedLang = localStorage.getItem("language");
        if (storedLang) {
          lang = storedLang;
          // 同步到 Cookie（确保 Cookie 存在）
          const cookieValue = `language=${lang}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
          document.cookie = cookieValue;
          console.log("LanguageInit: 从localStorage设置语言并同步到Cookie", lang, cookieValue);
          
          // 验证 Cookie 是否设置成功
          setTimeout(() => {
            const verifyCookie = document.cookie.split(";").find(c => c.trim().startsWith("language="));
            console.log("LanguageInit: Cookie验证", verifyCookie);
            if (!verifyCookie || !verifyCookie.includes(lang)) {
              console.error("LanguageInit: Cookie设置失败！重试...");
              document.cookie = cookieValue;
            }
          }, 10);
        }
      }
      
      // 设置全局变量
      window.__currentLanguage = lang;
      document.documentElement.lang = lang;
      
      // 调试输出
      console.log("LanguageInit: 最终设置语言为", lang);
      console.log("LanguageInit: 当前Cookie", document.cookie);
      console.log("LanguageInit: 全局变量", window.__currentLanguage);
    }
  })();
</script>